<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<<<<<<< HEAD
    <title>Dashboard - Deloitte Vulnerable Bank</title>
=======
    <title>Dashboard - Secure Bank</title>
>>>>>>> bbe1852392e7a3eb23de8862d26627e8a5f29efc
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom Styles & Configuration for Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            'lime': '#A3E635', // Light lime for accents
                            'lime-dark': '#84CC16', // Darker lime for hover states
                            'base': '#111827', // Dark gray, almost black
                            'surface': '#1F2937', // Slightly lighter gray for cards
                            'muted': '#9CA3AF', // Muted text color
                        },
                    },
                },
            },
        };
    </script>

    <style>
        /* Custom scrollbar for a modern look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1F2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4B5563;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6B7280;
        }
        /* Style for active nav link */
        .nav-link.active {
            background-color: #374151;
            color: #A3E635;
        }
        /* Hide sections by default */
        .dashboard-section {
            display: none;
        }
        /* Show the active section */
        .dashboard-section.active {
            display: block;
        }
        /* Simple transition for modals */
        .modal {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="bg-brand-base text-white font-sans antialiased">

    <div class="flex h-screen overflow-hidden">
        <!-- Side Panel Navigation -->
        <aside id="side-panel" class="fixed inset-y-0 left-0 z-30 w-64 bg-brand-surface transform -translate-x-full transition-transform duration-300 ease-in-out md:relative md:translate-x-0">
            <div class="flex items-center justify-center h-20 border-b border-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-brand-lime" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
                <h1 class="text-2xl font-bold ml-2">Secure Bank</h1>
            </div>
            <nav class="mt-6">
                <!-- Navigation Links -->
                <a href="#profile" class="nav-link flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700 hover:text-brand-lime transition-colors duration-200" onclick="setActiveLink(this)">
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                    <span class="ml-4">Profile</span>
                </a>
                <a href="#transfers" class="nav-link flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700 hover:text-brand-lime transition-colors duration-200" onclick="setActiveLink(this)">
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
                    <span class="ml-4">Money Transfer</span>
                </a>
                <a href="#loans" class="nav-link flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700 hover:text-brand-lime transition-colors duration-200" onclick="setActiveLink(this)">
                     <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01" /></svg>
                    <span class="ml-4">Loans</span>
                </a>
                <a href="#transactions" class="nav-link flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700 hover:text-brand-lime transition-colors duration-200" onclick="setActiveLink(this)">
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                    <span class="ml-4">Transaction History</span>
                </a>
                <a href="#virtual-cards" class="nav-link flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700 hover:text-brand-lime transition-colors duration-200" onclick="setActiveLink(this)">
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H7a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>
                    <span class="ml-4">Virtual Cards</span>
                </a>
                <a href="#bill-payments" class="nav-link flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700 hover:text-brand-lime transition-colors duration-200" onclick="setActiveLink(this)">
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                    <span class="ml-4">Bill Payments</span>
                </a>
                
                <!-- Admin Panel Link (Conditional) -->
                {% if is_admin %}
                <a href="{{ url_for('admin_panel') }}" class="nav-link flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700 hover:text-brand-lime transition-colors duration-200">
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    <span class="ml-4">Admin Panel</span>
                </a>
                {% endif %}
                
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700 hover:text-brand-lime transition-colors duration-200" onclick="logout()">
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    <span class="ml-4">Logout</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="flex items-center justify-between h-20 px-6 bg-brand-base border-b border-gray-800">
                <!-- Mobile Menu Toggle -->
                <button class="md:hidden text-gray-300 hover:text-white" onclick="toggleSidePanel()">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>
                <div class="hidden md:block">
                    <!-- Placeholder for search or other header items -->
                </div>
                <div class="flex items-center">
                    <span class="text-gray-300 mr-4">Welcome back, {{ username | safe }}</span>
                    <img class="h-10 w-10 rounded-full object-cover" 
                         src="{{ url_for('static', filename='uploads/' + user.profile_picture) if user.profile_picture else url_for('static', filename='uploads/user.png') }}" 
                         alt="User Avatar"
                         onerror="this.onerror=null;this.src='https://placehold.co/100x100/A3E635/111827?text=A';">
                </div>
            </header>

            <!-- Main content scrollable area -->
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-brand-base p-6 md:p-8">
                
                <!-- Greeting and Balance Card -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                    <div class="lg:col-span-2">
                         <h1 class="text-3xl font-bold text-white">Dashboard</h1>
                         <p id="current-date" class="text-brand-muted mt-1">Today is a great day to manage your finances.</p>
                    </div>
                    <div class="bg-brand-surface p-6 rounded-xl shadow-lg border border-gray-700">
                        <div class="text-brand-muted text-sm">Current Balance</div>
                        <div class="text-4xl font-bold text-brand-lime mt-2" id="balance">${{ balance }}</div>
                        <div class="text-brand-muted text-xs mt-2">Account: <span id="account-number">{{ account_number }}</span></div>
                    </div>
                </div>

                <!-- Global Message Div -->
                <div id="message" class="hidden p-4 mb-4 text-sm text-white bg-brand-lime/20 border border-brand-lime rounded-lg" role="alert"></div>

                <!-- Dashboard Content Sections -->
                <div id="dashboard-content">
                    <!-- Profile Section -->
                    <div id="profile" class="dashboard-section active">
                        <h2 class="text-2xl font-semibold mb-6">Profile</h2>
                        <div class="bg-brand-surface p-8 rounded-xl shadow-lg border border-gray-700 flex flex-col md:flex-row items-center gap-8">
                            <div class="relative">
                                <img id="profile-picture" class="h-32 w-32 rounded-full object-cover ring-4 ring-brand-lime" 
                                     src="{{ url_for('static', filename='uploads/' + user.profile_picture) if user.profile_picture else url_for('static', filename='uploads/user.png') }}" 
                                     alt="Profile Picture"
                                     onerror="this.onerror=null;this.src='https://placehold.co/128x128/A3E635/111827?text=A';">
                                <label for="profile_picture_input" class="absolute bottom-1 right-1 bg-brand-lime text-brand-base h-8 w-8 rounded-full flex items-center justify-center cursor-pointer hover:bg-brand-lime-dark transition">
                                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 5.232z" /></svg>
                                </label>
                            </div>
                            <div class="flex-1">
                                <form id="profileUploadForm" enctype="multipart/form-data" method="POST" action="/upload_profile_picture">
                                    <input type="file" id="profile_picture_input" name="profile_picture" accept="image/*" class="hidden" onchange="document.getElementById('profileUploadForm').submit();">
                                </form>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="text-sm text-brand-muted">Full Name</label>
                                        <p class="text-lg mt-1">{{ user.username }}</p>
                                    </div>
                                    <div>
                                        <label class="text-sm text-brand-muted">Email Address</label>
                                        <p class="text-lg mt-1">{{ user.email }}</p>
                                    </div>
                                    <div>
                                        <label class="text-sm text-brand-muted">Member Since</label>
                                        <p class="text-lg mt-1">{{ user.registered_on.strftime('%b %d, %Y') }}</p>
                                    </div>
                                     <div>
                                        <label class="text-sm text-brand-muted">Account Type</label>
                                        <p class="text-lg mt-1">Premium Checking</p>
                                    </div>
                                </div>
                                <div id="upload-message" class="mt-4 text-sm"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Money Transfer Section -->
                    <div id="transfers" class="dashboard-section">
                        <h2 class="text-2xl font-semibold mb-6">Money Transfer</h2>
                        <div class="bg-brand-surface p-8 rounded-xl shadow-lg border border-gray-700">
                            <form id="transferForm" class="space-y-6">
                                <div>
                                    <label for="to_account" class="block text-sm font-medium text-brand-muted">Recipient Account Number</label>
                                    <input type="text" id="to_account" name="to_account" class="mt-1 block w-full bg-gray-900 border-gray-600 rounded-md shadow-sm focus:ring-brand-lime focus:border-brand-lime sm:text-sm p-3" placeholder="Enter recipient's account number" required>
                                </div>
                                <div>
                                    <label for="amount" class="block text-sm font-medium text-brand-muted">Amount</label>
                                    <input type="number" id="amount" name="amount" class="mt-1 block w-full bg-gray-900 border-gray-600 rounded-md shadow-sm focus:ring-brand-lime focus:border-brand-lime sm:text-sm p-3" placeholder="$0.00" step="0.01" required>
                                </div>
                                <div>
                                    <label for="description" class="block text-sm font-medium text-brand-muted">Description (optional)</label>
                                    <textarea id="description" name="description" rows="3" class="mt-1 block w-full bg-gray-900 border-gray-600 rounded-md shadow-sm focus:ring-brand-lime focus:border-brand-lime sm:text-sm p-3" placeholder="e.g., Dinner with friends"></textarea>
                                </div>
                                <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-brand-base bg-brand-lime hover:bg-brand-lime-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-lime-dark transition">Send Money</button>
                            </form>
                        </div>
                    </div>

                    <!-- Loans Section -->
                    <div id="loans" class="dashboard-section">
                        <h2 class="text-2xl font-semibold mb-6">Request a Loan</h2>
                         <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div class="lg:col-span-1 bg-brand-surface p-8 rounded-xl shadow-lg border border-gray-700">
                                <form id="loanForm" class="space-y-6">
                                    <div>
                                        <label for="loan_amount" class="block text-sm font-medium text-brand-muted">Loan Amount</label>
                                        <input type="number" id="loan_amount" name="amount" class="mt-1 block w-full bg-gray-900 border-gray-600 rounded-md shadow-sm focus:ring-brand-lime focus:border-brand-lime sm:text-sm p-3" placeholder="Enter desired amount" step="100" required>
                                    </div>
                                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-brand-base bg-brand-lime hover:bg-brand-lime-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-lime-dark transition">Submit Loan Request</button>
                                </form>
                            </div>
                            <div class="lg:col-span-2 bg-brand-surface p-8 rounded-xl shadow-lg border border-gray-700">
                                <h3 class="text-lg font-medium mb-4">Your Loan Applications</h3>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-700">
                                        <thead class="bg-gray-800">
                                            <tr>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-brand-muted uppercase tracking-wider">Amount</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-brand-muted uppercase tracking-wider">Status</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-brand-muted uppercase tracking-wider">Date</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-brand-surface divide-y divide-gray-700">
                                            {% if loans %}
                                                {% for loan in loans %}
                                                <tr>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${{ "%.2f"|format(loan[2]) }}</td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                                        {% if loan[3] == 'approved' %}
                                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-900 text-green-300 capitalize">{{ loan[3] }}</span>
                                                        {% elif loan[3] == 'pending' %}
                                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-900 text-yellow-300 capitalize">{{ loan[3] }}</span>
                                                        {% else %}
                                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-900 text-red-300 capitalize">{{ loan[3] }}</span>
                                                        {% endif %}
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-brand-muted">{{ loan[4].strftime('%Y-%m-%d') }}</td>
                                                </tr>
                                                {% endfor %}
                                            {% else %}
                                                <tr>
                                                    <td colspan="3" class="px-6 py-4 text-center text-brand-muted">No loan applications found.</td>
                                                </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Transaction History Section -->
                    <div id="transactions" class="dashboard-section">
                        <h2 class="text-2xl font-semibold mb-6">Transaction History</h2>
                        <div class="bg-brand-surface rounded-xl shadow-lg border border-gray-700 overflow-hidden">
                            <div id="transaction-list" class="overflow-x-auto">
                                <!-- This table will be populated by dashboard.js -->
                                <table class="min-w-full divide-y divide-gray-700">
                                    <thead class="bg-gray-800">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-brand-muted uppercase tracking-wider">Description</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-brand-muted uppercase tracking-wider">Date</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-brand-muted uppercase tracking-wider">Type</th>
                                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-brand-muted uppercase tracking-wider">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transaction-table-body" class="bg-brand-surface divide-y divide-gray-700">
                                        <!-- JS will insert rows here. Initial loading state: -->
                                        <tr>
                                            <td colspan="4" class="px-6 py-10 text-center text-brand-muted">
                                                <div class="flex justify-center items-center space-x-2">
                                                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-brand-lime"></div>
                                                    <span>Loading transactions...</span>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Virtual Cards Section -->
                    <div id="virtual-cards" class="dashboard-section">
                         <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-semibold">Virtual Cards</h2>
                            <button onclick="showCreateCardModal()" class="flex items-center justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-brand-base bg-brand-lime hover:bg-brand-lime-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-lime-dark transition">
                                <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                                Create New Card
                            </button>
                        </div>
                        <div id="virtual-cards-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- JS will populate cards here -->
                            <div id="virtual-cards-placeholder" class="text-center text-brand-muted py-10 md:col-span-2 lg:col-span-3">
                                <div class="flex justify-center items-center space-x-2">
                                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-brand-lime"></div>
                                    <span>Loading virtual cards...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bill Payments Section -->
                    <div id="bill-payments" class="dashboard-section">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-semibold">Bill Payments</h2>
                            <button onclick="showPayBillModal()" class="flex items-center justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-brand-base bg-brand-lime hover:bg-brand-lime-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-lime-dark transition">
                                Pay New Bill
                            </button>
                        </div>
                        <div class="bg-brand-surface rounded-xl shadow-lg border border-gray-700 overflow-hidden">
                             <div id="bill-payments-list" class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-700">
                                    <thead class="bg-gray-800">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-brand-muted uppercase tracking-wider">Biller</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-brand-muted uppercase tracking-wider">Date</th>
                                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-brand-muted uppercase tracking-wider">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bill-payments-table-body" class="bg-brand-surface divide-y divide-gray-700">
                                       <!-- JS will insert rows here. Initial loading state: -->
                                        <tr>
                                            <td colspan="3" class="px-6 py-10 text-center text-brand-muted">
                                                <div class="flex justify-center items-center space-x-2">
                                                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-brand-lime"></div>
                                                    <span>Loading payment history...</span>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <!-- Create Card Modal -->
    <div id="createCardModal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden" onclick="event.target === this && hideCreateCardModal()">
        <div class="bg-brand-surface rounded-lg shadow-xl p-8 w-full max-w-md">
            <h3 class="text-xl font-semibold mb-6">Create Virtual Card</h3>
            <form id="createCardForm" class="space-y-4">
                <div>
                    <label for="card_limit" class="block text-sm font-medium text-brand-muted">Card Limit</label>
                    <input type="number" id="card_limit" name="card_limit" class="mt-1 block w-full bg-gray-900 border-gray-600 rounded-md shadow-sm focus:ring-brand-lime focus:border-brand-lime sm:text-sm p-3" placeholder="$1000.00" required>
                </div>
                <div>
                    <label for="card_type" class="block text-sm font-medium text-brand-muted">Card Type</label>
                    <select id="card_type" name="card_type" class="mt-1 block w-full bg-gray-900 border-gray-600 rounded-md shadow-sm focus:ring-brand-lime focus:border-brand-lime sm:text-sm p-3" required>
                        <option value="standard">Standard</option>
                        <option value="premium">Premium</option>
                    </select>
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" onclick="hideCreateCardModal()" class="py-2 px-4 border border-gray-600 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-700 transition">Cancel</button>
                    <button type="submit" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-brand-base bg-brand-lime hover:bg-brand-lime-dark transition">Create Card</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Card Details Modal -->
    <div id="cardDetailsModal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden" onclick="event.target === this && hideCardDetailsModal()">
         <div class="bg-brand-surface rounded-lg shadow-xl p-8 w-full max-w-md">
            <h3 class="text-xl font-semibold mb-6">Card Details</h3>
            <div id="cardDetailsContent" class="space-y-4">
                <!-- JS will populate this -->
            </div>
             <div class="flex justify-end pt-6">
                <button onclick="hideCardDetailsModal()" class="py-2 px-4 border border-gray-600 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-700 transition">Close</button>
            </div>
        </div>
    </div>

    <!-- Pay Bill Modal -->
    <div id="payBillModal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden" onclick="event.target === this && hidePayBillModal()">
        <div class="bg-brand-surface rounded-lg shadow-xl p-8 w-full max-w-md">
            <h3 class="text-xl font-semibold mb-6">Pay Bill</h3>
            <form id="payBillForm" class="space-y-4">
                <div>
                     <label for="billCategory" class="block text-sm font-medium text-brand-muted">Category</label>
                     <select id="billCategory" onchange="loadBillers(this.value)" class="mt-1 block w-full bg-gray-900 border-gray-600 rounded-md shadow-sm p-3" required><option value="">Select Category</option></select>
                </div>
                 <div>
                     <label for="biller" class="block text-sm font-medium text-brand-muted">Biller</label>
                     <select id="biller" name="biller_id" class="mt-1 block w-full bg-gray-900 border-gray-600 rounded-md shadow-sm p-3" required disabled><option value="">Select Biller</option></select>
                </div>
                <div>
                    <label for="bill_amount" class="block text-sm font-medium text-brand-muted">Amount</label>
                    <input type="number" id="bill_amount" name="amount" class="mt-1 block w-full bg-gray-900 border-gray-600 rounded-md p-3" required>
                </div>
                <div>
                     <label for="payment_method" class="block text-sm font-medium text-brand-muted">Payment Method</label>
                     <select id="payment_method" name="payment_method" onchange="toggleCardSelection(this.value)" class="mt-1 block w-full bg-gray-900 border-gray-600 rounded-md p-3" required>
                        <option value="balance">Account Balance</option>
                        <option value="virtual_card">Virtual Card</option>
                     </select>
                </div>
                <div class="form-group" id="cardSelection" style="display: none;">
                    <label for="card_id" class="block text-sm font-medium text-brand-muted">Select Card</label>
                    <select id="card_id" name="card_id" class="mt-1 block w-full bg-gray-900 border-gray-600 rounded-md shadow-sm p-3">
                        <option value="">Select Card</option>
                    </select>
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" onclick="hidePayBillModal()" class="py-2 px-4 border border-gray-600 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-700 transition">Cancel</button>
                    <button type="submit" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-brand-base bg-brand-lime hover:bg-brand-lime-dark transition">Pay Now</button>
                </div>
            </form>
        </div>
    </div>


    <script>
    // This script now handles frontend interactions and fetches dynamic data from the backend.
    // It assumes your Flask backend provides the necessary endpoints.

    // --- State Management ---
    let activeSection = 'profile';

    // --- DOM Elements ---
    const sidePanel = document.getElementById('side-panel');
    const navLinks = document.querySelectorAll('.nav-link');
    const sections = document.querySelectorAll('.dashboard-section');
    const messageDiv = document.getElementById('message');
    const createCardModal = document.getElementById('createCardModal');
    const cardDetailsModal = document.getElementById('cardDetailsModal');
    const payBillModal = document.getElementById('payBillModal');

    // --- Functions ---

    /**
     * Toggles the visibility of the side panel on mobile.
     */
    function toggleSidePanel() {
        sidePanel.classList.toggle('-translate-x-full');
    }

    /**
     * Sets the active navigation link and displays the corresponding section.
     * @param {HTMLElement} el The clicked navigation link element.
     */
    function setActiveLink(el) {
        const newSectionId = el.getAttribute('href').substring(1);

        // Update nav links
        navLinks.forEach(link => link.classList.remove('active'));
        el.classList.add('active');
        
        // Update content sections
        sections.forEach(section => {
            if (section.id === newSectionId) {
                section.classList.add('active');
            } else {
                section.classList.remove('active');
            }
        });

        activeSection = newSectionId;

        // Trigger data loading for the activated section
        loadSectionData(newSectionId);

        // Close side panel on mobile after navigation
        if (window.innerWidth < 768) {
            toggleSidePanel();
        }
    }

    /**
     * Displays a global message to the user.
     * @param {string} text The message to display.
     * @param {string} type The type of message ('success', 'error').
     */
    function showMessage(text, type = 'success') {
        messageDiv.innerHTML = text; // Use innerHTML to allow for bold/other tags
        messageDiv.classList.remove('hidden', 'bg-brand-lime/20', 'border-brand-lime', 'bg-red-500/20', 'border-red-500');
        if (type === 'success') {
            messageDiv.classList.add('bg-brand-lime/20', 'border-brand-lime');
        } else {
            messageDiv.classList.add('bg-red-500/20', 'border-red-500');
        }
        setTimeout(() => {
            messageDiv.classList.add('hidden');
        }, 5000);
    }

    // Modal Controls
    function showCreateCardModal() { createCardModal.classList.remove('hidden'); }
    function hideCreateCardModal() { createCardModal.classList.add('hidden'); }
    function showCardDetailsModal(card) { 
        const content = document.getElementById('cardDetailsContent');
        content.innerHTML = `
            <p><strong>Card Number:</strong> ${card.card_number}</p>
            <p><strong>CVV:</strong> ${card.cvv}</p>
            <p><strong>Expires:</strong> ${card.expiry_date}</p>
            <p><strong>Limit:</strong> $${parseFloat(card.card_limit).toFixed(2)}</p>
            <p><strong>Type:</strong> <span class="capitalize">${card.card_type}</span></p>
        `;
        cardDetailsModal.classList.remove('hidden'); 
    }
    function hideCardDetailsModal() { cardDetailsModal.classList.add('hidden'); }
    function showPayBillModal() { 
        loadBillCategories();
        payBillModal.classList.remove('hidden'); 
    }
    function hidePayBillModal() { payBillModal.classList.add('hidden'); }

    /**
     * Handles the logout process.
     */
    function logout() {
        // Redirect to the logout route
        window.location.href = '/logout';
    }

    // --- Data Fetching and Rendering ---

    /**
     * Fetches and renders transaction history.
     */
    async function fetchTransactions() {
        const tbody = document.getElementById('transaction-table-body');
        try {
            const response = await fetch('/get_transactions');
            if (!response.ok) throw new Error('Failed to fetch transactions');
            const transactions = await response.json();
            
            tbody.innerHTML = ''; // Clear loading state
            if (transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-brand-muted">No transactions found.</td></tr>';
                return;
            }

            transactions.forEach(tx => {
                const row = document.createElement('tr');
                const amountClass = tx.type === 'incoming' ? 'text-green-400' : 'text-red-400';
                const amountPrefix = tx.type === 'incoming' ? '+' : '-';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${tx.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-brand-muted">${tx.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-brand-muted capitalize">${tx.type}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${amountClass} text-right">${amountPrefix}$${parseFloat(tx.amount).toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
        } catch (error) {
            console.error('Error fetching transactions:', error);
            tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-red-400">Could not load transactions.</td></tr>';
        }
    }

    /**
     * Fetches and renders virtual cards.
     */
    async function fetchVirtualCards() {
        const container = document.getElementById('virtual-cards-list');
        try {
            const response = await fetch('/get_virtual_cards');
            if (!response.ok) throw new Error('Failed to fetch virtual cards');
            const cards = await response.json();

            container.innerHTML = ''; // Clear loading state
            if (cards.length === 0) {
                container.innerHTML = '<p class="text-center text-brand-muted py-10 md:col-span-2 lg:col-span-3">No virtual cards found. Click "Create New Card" to get started.</p>';
                return;
            }

            cards.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = "bg-gradient-to-br from-lime-500 to-green-600 p-6 rounded-xl shadow-lg text-white relative cursor-pointer hover:scale-105 transition-transform";
                cardEl.innerHTML = `
                    <div class="flex justify-between items-start">
                        <span class="font-bold text-lg">Secure Bank</span>
                        <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H7a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>
                    </div>
                    <div class="mt-8 font-mono text-xl tracking-widest">${card.card_number}</div>
                    <div class="flex justify-between items-end mt-4">
                        <div>
                            <div class="text-xs opacity-70">Card Holder</div>
                            <div>{{ user.username }}</div>
                        </div>
                        <div>
                            <div class="text-xs opacity-70">Expires</div>
                            <div>${card.expiry_date}</div>
                        </div>
                    </div>
                `;
                cardEl.onclick = () => showCardDetailsModal(card);
                container.appendChild(cardEl);
            });
        } catch (error) {
            console.error('Error fetching virtual cards:', error);
            container.innerHTML = '<p class="text-center text-red-400 py-10 md:col-span-2 lg:col-span-3">Could not load virtual cards.</p>';
        }
    }
    
    /**
     * Fetches and renders bill payment history.
     */
    async function fetchBillPayments() {
        const tbody = document.getElementById('bill-payments-table-body');
        try {
            const response = await fetch('/get_bill_payments');
            if (!response.ok) throw new Error('Failed to fetch bill payments');
            const payments = await response.json();
            
            tbody.innerHTML = ''; // Clear loading state
            if (payments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-brand-muted">No bill payment history.</td></tr>';
                return;
            }

            payments.forEach(p => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${p.biller_name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-brand-muted">${p.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-white text-right">-$${parseFloat(p.amount).toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
        } catch (error) {
            console.error('Error fetching bill payments:', error);
            tbody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-red-400">Could not load payment history.</td></tr>';
        }
    }

    /**
     * Loads necessary data when a section becomes active.
     * @param {string} sectionId The ID of the section to load data for.
     */
    function loadSectionData(sectionId) {
        switch (sectionId) {
            case 'transactions':
                fetchTransactions();
                break;
            case 'virtual-cards':
                fetchVirtualCards();
                break;
            case 'bill-payments':
                fetchBillPayments();
                break;
        }
    }
    
    /**
     * Fetches biller categories and populates the dropdown.
     */
    async function loadBillCategories() {
        const categorySelect = document.getElementById('billCategory');
        try {
            const response = await fetch('/get_bill_categories');
            const categories = await response.json();
            categorySelect.innerHTML = '<option value="">Select Category</option>'; // Reset
            categories.forEach(cat => {
                const option = new Option(cat.name, cat.id);
                categorySelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error fetching bill categories:', error);
        }
    }

    /**
     * Fetches billers for a selected category.
     */
    async function loadBillers(categoryId) {
        const billerSelect = document.getElementById('biller');
        if (!categoryId) {
            billerSelect.innerHTML = '<option value="">Select Biller</option>';
            billerSelect.disabled = true;
            return;
        }
        try {
            const response = await fetch(`/get_billers/${categoryId}`);
            const billers = await response.json();
            billerSelect.innerHTML = '<option value="">Select Biller</option>'; // Reset
            billers.forEach(b => {
                const option = new Option(b.name, b.id);
                billerSelect.appendChild(option);
            });
            billerSelect.disabled = false;
        } catch (error) {
            console.error('Error fetching billers:', error);
            billerSelect.disabled = true;
        }
    }
    
    /**
     * Toggles the visibility of the virtual card selection dropdown in the pay bill modal.
     */
    function toggleCardSelection(paymentMethod) {
        const cardSelectionDiv = document.getElementById('cardSelection');
        const cardSelect = document.getElementById('card_id');
        if (paymentMethod === 'virtual_card') {
            cardSelectionDiv.style.display = 'block';
            cardSelect.required = true;
            // Fetch user's virtual cards to populate the dropdown
            fetch('/get_virtual_cards')
                .then(res => res.json())
                .then(cards => {
                    cardSelect.innerHTML = '<option value="">Select Card</option>';
                    cards.forEach(card => {
                        const option = new Option(card.card_number, card.id);
                        cardSelect.appendChild(option);
                    });
                });
        } else {
            cardSelectionDiv.style.display = 'none';
            cardSelect.required = false;
        }
    }

    // --- Event Listeners ---
    
    document.getElementById('transferForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        
        try {
            const response = await fetch('/transfer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });
            const result = await response.json();
            if (response.ok) {
                showMessage(`<strong>Success!</strong> ${result.message}`, 'success');
                document.getElementById('balance').textContent = '$' + result.new_balance;
                e.target.reset();
            } else {
                throw new Error(result.message || 'Transfer failed');
            }
        } catch (error) {
            showMessage(`<strong>Error:</strong> ${error.message}`, 'error');
        }
    });
    
    document.getElementById('loanForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());

        try {
            const response = await fetch('/request_loan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });
            const result = await response.json();
            if (response.ok) {
                showMessage('<strong>Success!</strong> Loan request submitted for review.', 'success');
                // You might want to reload the page or dynamically update the loans table here
                setTimeout(() => window.location.reload(), 2000);
            } else {
                throw new Error(result.message || 'Loan request failed');
            }
        } catch (error) {
            showMessage(`<strong>Error:</strong> ${error.message}`, 'error');
        }
    });

    document.getElementById('createCardForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());

        try {
            const response = await fetch('/create_virtual_card', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });
            const result = await response.json();
            if (response.ok) {
                hideCreateCardModal();
                showMessage('<strong>Success!</strong> Virtual card created.', 'success');
                fetchVirtualCards(); // Refresh the card list
            } else {
                throw new Error(result.message || 'Could not create card');
            }
        } catch (error) {
            showMessage(`<strong>Error:</strong> ${error.message}`, 'error');
        }
    });

    document.getElementById('payBillForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());

        try {
            const response = await fetch('/pay_bill', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });
            const result = await response.json();
            if (response.ok) {
                hidePayBillModal();
                showMessage('<strong>Success!</strong> Bill paid successfully.', 'success');
                fetchBillPayments(); // Refresh payment history
                if(result.new_balance) {
                    document.getElementById('balance').textContent = '$' + result.new_balance;
                }
            } else {
                throw new Error(result.message || 'Bill payment failed');
            }
        } catch (error) {
            showMessage(`<strong>Error:</strong> ${error.message}`, 'error');
        }
    });

    // Set the current date on the dashboard
    document.addEventListener('DOMContentLoaded', () => {
        const dateEl = document.getElementById('current-date');
        const today = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        dateEl.textContent = today.toLocaleDateString('en-US', options);

        // Set the initial active link based on the hash or default
        const hash = window.location.hash || '#profile';
        const initialLink = document.querySelector(`.nav-link[href='${hash}']`);
        if (initialLink) {
            setActiveLink(initialLink);
        } else {
            // Fallback to the first link if hash is invalid
            setActiveLink(navLinks[0]);
        }
    });

    </script>

</body>
</html>
